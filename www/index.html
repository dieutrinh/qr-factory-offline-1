<script>
const $ = id => document.getElementById(id);
const msg = (t, cls) => { const m=$("msg"); m.textContent=t; m.className="msg "+cls; };

let lastScanUrl = "";
let lastQrDataUrl = "";
let lastCode = "";

function setButtonsEnabled(on){
  ["btnCreate","btnOpen","btnPng","btnPdf"].forEach(id=>{
    const b = document.getElementById(id);
    if(!b) return;
    b.disabled = !on;
    b.style.opacity = on ? "1" : "0.6";
    b.style.cursor = on ? "pointer" : "not-allowed";
  });
}

async function apiGet(path){
  return await window.qrFactory.apiGet(path);
}
async function apiPost(path, body){
  return await window.qrFactory.apiPost(path, body);
}

function renderQr(dataUrl){
  const box = $("qrBox");
  box.innerHTML = "";
  const img = new Image();
  img.src = dataUrl;
  box.appendChild(img);
}

async function createQr(){
  const payload = {
    product_name: $("product").value,
    batch_serial: $("batch").value,
    mfg_date: $("mfg").value,
    exp_date: $("exp").value,
    note_extra: $("note").value,
    status: $("status").value,
    code: $("code").value.trim() // có thì dùng, không thì server tự sinh
  };

  const r = await apiPost("/api/qr", payload);
  if(!r?.ok) throw new Error("Create failed");

  lastCode = r.code;
  lastScanUrl = r.scanUrl;

  $("outCode").textContent = lastCode;
  $("outUrl").textContent = lastScanUrl;

  // ✅ QR đúng link scan (qr.html?token=...)
  lastQrDataUrl = await window.qrFactory.toDataUrl(lastScanUrl, { width: 360, margin: 1 });
  renderQr(lastQrDataUrl);

  msg("Tạo QR + lưu DB OK ✅", "ok");
}

async function openLink(){
  if(!lastScanUrl) return msg("Chưa có URL", "err");
  await window.qrFactory.openExternal(lastScanUrl);
}

async function dlPng(){
  if(!lastQrDataUrl) return msg("Chưa có QR/URL", "err");
  await window.qrFactory.savePng({ filename: `${lastCode||"qr"}.png`, dataUrl: lastQrDataUrl });
}

async function dlPdf(){
  await window.qrFactory.savePdf({ filename: `${lastCode||"qr"}.pdf` });
}

document.addEventListener("DOMContentLoaded", async ()=>{
  setButtonsEnabled(false);

  try{
    await apiGet("/api/health");
    msg("Ready ✅ Server OK", "ok");
    setButtonsEnabled(true);
  }catch(e){
    msg("Server chưa sẵn sàng.", "err");
    setButtonsEnabled(false);
  }

  $("btnCreate").onclick = ()=>createQr().catch(e=>msg(String(e.message||e),"err"));
  $("btnOpen").onclick   = ()=>openLink().catch(e=>msg(String(e.message||e),"err"));
  $("btnPng").onclick    = ()=>dlPng().catch(e=>msg(String(e.message||e),"err"));
  $("btnPdf").onclick    = ()=>dlPdf().catch(e=>msg(String(e.message||e),"err"));
});
</script>
