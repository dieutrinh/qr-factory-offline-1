async function apiGet(path){
  for (let i=0;i<6;i++){
    try{
      if (window.qrFactory?.apiGet) return await window.qrFactory.apiGet(path);
      const r = await fetch(path);
      if(!r.ok) throw new Error(await r.text());
      return await r.json();
    }catch(e){
      const msg = String(e?.message||e);
      if (msg.includes("ECONNREFUSED") || msg.includes("Failed to fetch")) {
        await new Promise(r=>setTimeout(r, 400));
        continue;
      }
      throw e;
    }
  }
  throw new Error("Server chưa chạy (ECONNREFUSED 127.0.0.1:3000). Hãy chạy bằng EXE hoặc bật server.js.");
}

async function apiPost(path, body){
  for (let i=0;i<6;i++){
    try{
      if (window.qrFactory?.apiPost) return await window.qrFactory.apiPost(path, body);
      const r = await fetch(path,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      if(!r.ok) throw new Error(await r.text());
      return await r.json();
    }catch(e){
      const msg = String(e?.message||e);
      if (msg.includes("ECONNREFUSED") || msg.includes("Failed to fetch")) {
        await new Promise(r=>setTimeout(r, 400));
        continue;
      }
      throw e;
    }
  }
  throw new Error("Server chưa chạy (ECONNREFUSED 127.0.0.1:3000).");
}
