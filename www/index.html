<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Factory V2 ‚Äî Generate</title>
  <style>
    :root{
      --bg:#071022; --panel:#0b1a33; --panel2:#0a1630;
      --txt:#d7e2ff; --muted:#92a6d6; --line:#1e3566;
      --btn:#2f6bff; --btn2:#203a70; --warn:#ffcc66; --ok:#8fffb7; --err:#ff8f8f;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.4 system-ui,Segoe UI,Arial}
    .wrap{padding:18px}
    .grid{display:grid;grid-template-columns: 1.15fr 0.85fr;gap:18px;align-items:start}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:18px;padding:16px}
    h1{font-size:20px;margin:0 0 10px}
    .sub{color:var(--muted);margin:0 0 10px}
    a{color:#b7ccff}
    hr{border:none;border-top:1px solid var(--line);margin:12px 0}
    label{display:block;color:var(--muted);margin:10px 0 6px}
    input, textarea, select{
      width:100%; padding:12px 12px; border-radius:12px;
      border:1px solid var(--line); outline:none;
      background:#060f22; color:var(--txt);
    }
    textarea{min-height:76px; resize:vertical}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row2b{display:grid;grid-template-columns:1fr 1fr;gap:12px; align-items:end}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      border:1px solid var(--line); border-radius:12px;
      padding:10px 14px; color:var(--txt); background:var(--btn2);
      cursor:pointer; font-weight:600;
    }
    button.primary{background:var(--btn);border-color:#2f6bff}
    button.warn{outline:2px solid var(--warn); outline-offset:1px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#081636;color:var(--muted)}
    .resultBox{display:flex;flex-direction:column;gap:10px}
    .qrBox{
      width:220px; height:220px; border-radius:16px; border:1px dashed var(--line);
      display:flex; align-items:center; justify-content:center; background:#06102a;
      overflow:hidden;
    }
    .qrBox img{width:100%;height:100%;object-fit:contain}
    .tip{color:var(--muted);font-size:13px}
    .msg{margin-top:10px;font-size:13px}
    .msg.ok{color:var(--ok)}
    .msg.err{color:var(--err)}
  </style>
</head>

<body>
<div class="wrap">
  <div class="grid">
    <div class="card">
      <h1>üé® QR Factory V2 ‚Äî T·∫°o QR ƒë·ªông (5 fields)</h1>
      <p class="sub">
        ‚Ä¢ QR in s·∫µn ch·ª©a <b>ƒë∆∞·ªùng link</b> (file://.../qr.html?token=...) ‚Äî scan s·∫Ω ƒë·ªçc d·ªØ li·ªáu m·ªõi nh·∫•t b·∫°n ƒë√£ l∆∞u.<br/>
        ‚Ä¢ <a href="./admin.html">M·ªü Admin dashboard</a>
      </p>
      <hr />

      <label>Product Name</label>
      <input id="productName" placeholder="vd: s·∫ßu ri√™ng" />

      <label>Batch/Serial</label>
      <input id="batchSerial" placeholder="vd: ca 2" />

      <div class="row2">
        <div>
          <label>MFG Date (dd-mm-yyyy)</label>
          <input id="mfgDate" placeholder="23-12-2025" />
        </div>
        <div>
          <label>EXP Date (dd-mm-yyyy)</label>
          <input id="expDate" placeholder="25-12-2026" />
        </div>
      </div>

      <label>Note/Extra</label>
      <textarea id="noteExtra" placeholder="vd: 200000 vnd"></textarea>

      <div class="row2b">
        <div>
          <label>Status</label>
          <select id="status">
            <option value="active" selected>active</option>
            <option value="inactive">inactive</option>
          </select>
        </div>
        <div>
          <label>(Tu·ª≥ ch·ªçn) Code</label>
          <input id="codeOpt" placeholder="ƒê·ªÉ tr·ªëng = t·ª± sinh" />
        </div>
      </div>

      <div class="btnrow">
        <button class="primary" type="button" id="btnCreate">T·∫°o QR (l∆∞u DB)</button>
        <button type="button" id="btnOpen">M·ªü link scan</button>
        <button type="button" id="btnPng">T·∫£i PNG</button>
        <button class="warn" type="button" id="btnPdf">T·∫£i PDF</button>
      </div>

      <div id="msg" class="msg"></div>
    </div>

    <div class="card">
      <h1>üßæ K·∫øt qu·∫£</h1>
      <div class="resultBox">
        <div class="pill">Code: <span id="codeOut">-</span></div>
        <div class="pill">URL: <span id="urlOut">-</span></div>

        <div class="qrBox"><img id="qrImg" alt="QR Preview" /></div>

        <div class="tip">
          ‚Ä¢ PNG/PDF d√πng API Electron (<code>window.qrFactory</code>).<br/>
          ‚Ä¢ N·∫øu ch·∫°y b·∫±ng browser th∆∞·ªùng, PNG s·∫Ω download, PDF s·∫Ω d√πng print.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const msg = $("msg");
  const codeOut = $("codeOut");
  const urlOut  = $("urlOut");
  const qrImg   = $("qrImg");

  let lastQrDataUrl = "";
  let lastScanUrl = "";
  let lastCode = "";

  function setMsg(text, kind="") {
    msg.className = "msg " + (kind || "");
    msg.textContent = text || "";
  }

  function randCode(){
    return "QR" + Math.random().toString(36).slice(2, 10).toUpperCase();
  }

  function parseDMY(s){
    const m = /^(\d{2})-(\d{2})-(\d{4})$/.exec((s||"").trim());
    if(!m) return null;
    const dd = +m[1], mm = +m[2], yyyy = +m[3];
    if(mm < 1 || mm > 12) return null;
    const maxDay = new Date(yyyy, mm, 0).getDate();
    if(dd < 1 || dd > maxDay) return null;
    return { dd, mm, yyyy };
  }

  function dmyToISO(s){
    const p = parseDMY(s);
    if(!p) return null;
    return `${p.yyyy}-${String(p.mm).padStart(2,"0")}-${String(p.dd).padStart(2,"0")}`;
  }

  // ===== "DB" localStorage =====
  function loadDB() {
    try { return JSON.parse(localStorage.getItem("qrdb_products") || "{}"); }
    catch { return {}; }
  }
  function saveDB(db) {
    localStorage.setItem("qrdb_products", JSON.stringify(db));
  }
  function addHistory(evt) {
    const key = "qrdb_history";
    let arr = [];
    try { arr = JSON.parse(localStorage.getItem(key) || "[]"); } catch {}
    arr.unshift({ ...evt, ts: new Date().toISOString() });
    arr = arr.slice(0, 300);
    localStorage.setItem(key, JSON.stringify(arr));
  }

  function buildScanUrl(code) {
    // scan URL = file://.../qr.html?token=CODE (offline)
    const u = new URL("./qr.html", window.location.href);
    u.searchParams.set("token", code);
    return u.toString();
  }

  function downloadDataUrl(dataUrl, filename) {
    const a = document.createElement("a");
    a.href = dataUrl;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  async function openExternal(url) {
    if (!url) return;
    if (window.qrFactory?.openExternal) return await window.qrFactory.openExternal(url);
    window.open(url, "_blank");
  }

  async function createQr() {
    setMsg("");

    const product = $("productName").value.trim();
    const batch   = $("batchSerial").value.trim();
    const mfg     = $("mfgDate").value.trim();
    const exp     = $("expDate").value.trim();
    const note    = $("noteExtra").value.trim();
    const status  = $("status").value;
    const codeIn  = $("codeOpt").value.trim();

    if(!product) return setMsg("Thi·∫øu Product Name", "err");
    if(!batch)   return setMsg("Thi·∫øu Batch/Serial", "err");

    const mfgISO = dmyToISO(mfg);
    const expISO = dmyToISO(exp);
    if(!mfgISO) return setMsg("MFG Date sai ƒë·ªãnh d·∫°ng dd-mm-yyyy", "err");
    if(!expISO) return setMsg("EXP Date sai ƒë·ªãnh d·∫°ng dd-mm-yyyy", "err");

    const code = codeIn || randCode();
    const scanUrl = buildScanUrl(code);

    // save local DB
    const db = loadDB();
    db[code] = {
      code,
      product_name: product,
      batch_serial: batch,
      mfg_date: mfgISO,
      exp_date: expISO,
      note_extra: note,
      status,
      updated_at: new Date().toISOString()
    };
    saveDB(db);
    addHistory({ action: "create", code });

    // UI output
    lastCode = code;
    lastScanUrl = scanUrl;
    codeOut.textContent = code;
    urlOut.textContent = scanUrl;

    if (!window.qrFactory?.toDataUrl) {
      setMsg("Thi·∫øu window.qrFactory.toDataUrl (preload ch∆∞a ƒë√∫ng)", "err");
      return;
    }

    lastQrDataUrl = await window.qrFactory.toDataUrl(scanUrl);
    qrImg.src = lastQrDataUrl;

    setMsg("T·∫°o QR + l∆∞u DB OK ‚úÖ", "ok");
  }

  async function openLink() {
    if(!lastScanUrl) return setMsg("Ch∆∞a c√≥ URL ‚Äî b·∫•m T·∫°o QR tr∆∞·ªõc", "err");
    const r = await openExternal(lastScanUrl);
    if (r?.ok === false) return setMsg("Open link l·ªói: " + (r.error || "unknown"), "err");
    setMsg("ƒê√£ m·ªü link scan ‚úÖ", "ok");
  }

  async function dlPng() {
    if(!lastQrDataUrl) return setMsg("Ch∆∞a c√≥ QR preview ƒë·ªÉ t·∫£i PNG", "err");

    if (window.qrFactory?.savePng) {
      const r = await window.qrFactory.savePng({ filename: `${lastCode||"qr"}.png`, dataUrl: lastQrDataUrl });
      if (r?.canceled) return setMsg("ƒê√£ hu·ª∑ l∆∞u PNG", "");
      if (r?.ok === false) return setMsg("L∆∞u PNG l·ªói: " + (r.error || "unknown"), "err");
      return setMsg("ƒê√£ l∆∞u PNG ‚úÖ", "ok");
    }

    downloadDataUrl(lastQrDataUrl, `${lastCode||"qr"}.png`);
    setMsg("ƒê√£ download PNG ‚úÖ", "ok");
  }

  async function dlPdf() {
    if (window.qrFactory?.savePdf) {
      const r = await window.qrFactory.savePdf({ filename: `${lastCode||"qr"}.pdf` });
      if (r?.canceled) return setMsg("ƒê√£ hu·ª∑ l∆∞u PDF", "");
      if (r?.ok === false) return setMsg("L∆∞u PDF l·ªói: " + (r.error || "unknown"), "err");
      return setMsg("ƒê√£ l∆∞u PDF ‚úÖ", "ok");
    }

    // browser fallback
    window.print();
    setMsg("ƒê√£ m·ªü print dialog (PDF) ‚úÖ", "ok");
  }

  document.addEventListener("DOMContentLoaded", () => {
    $("btnCreate").addEventListener("click", () => createQr().catch(e => setMsg(String(e?.message||e), "err")));
    $("btnOpen").addEventListener("click", () => openLink().catch(e => setMsg(String(e?.message||e), "err")));
    $("btnPng").addEventListener("click", () => dlPng().catch(e => setMsg(String(e?.message||e), "err")));
    $("btnPdf").addEventListener("click", () => dlPdf().catch(e => setMsg(String(e?.message||e), "err")));
    setMsg("Ready ‚úÖ", "ok");
  });
})();
</script>
</body>
</html>
