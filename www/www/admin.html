<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Factory V2 ‚Äî Admin</title>
  <style>
    :root{
      --bg:#071022; --panel:#0b1a33; --panel2:#0a1630;
      --txt:#d7e2ff; --muted:#92a6d6; --line:#1e3566;
      --btn:#2f6bff; --btn2:#203a70; --ok:#8fffb7; --err:#ff8f8f;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.4 system-ui,Segoe UI,Arial}
    .wrap{padding:18px;max-width:1200px;margin:0 auto}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:18px;padding:16px}
    h1{margin:0 0 8px;font-size:20px}
    a{color:#b7ccff}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0}
    input, textarea, select{
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background:#060f22;color:var(--txt);outline:none;
    }
    button{
      border:1px solid var(--line); border-radius:12px;
      padding:10px 14px; color:var(--txt); background:var(--btn2);
      cursor:pointer; font-weight:600;
    }
    button.primary{background:var(--btn);border-color:#2f6bff}
    .msg{margin-top:10px;font-size:13px}
    .msg.ok{color:var(--ok)}
    .msg.err{color:var(--err)}
    table{width:100%;border-collapse:collapse;margin-top:10px;overflow:auto}
    th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left;vertical-align:top}
    th{color:var(--muted);font-weight:600}
    .small{color:var(--muted);font-size:12px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#081636;color:var(--muted);font-size:12px}
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>üõ†Ô∏è Admin Dashboard</h1>
    <div class="small">
      <a href="./index.html">‚Üê V·ªÅ Generate</a>
      ‚Ä¢ D·ªØ li·ªáu ƒëang l∆∞u offline trong localStorage (qrdb_products / qrdb_history).
    </div>

    <div class="row">
      <input id="q" placeholder="T√¨m code / product / batch..." style="min-width:260px;flex:1" />
      <button class="primary" id="btnReload">Reload</button>
      <button id="btnExportCsv">Export CSV</button>
      <button id="btnClearHistory">Clear History</button>
    </div>

    <div id="msg" class="msg"></div>

    <h3 style="margin:14px 0 6px">S·∫£n ph·∫©m</h3>
    <div class="small">Click code ƒë·ªÉ m·ªü trang scan.</div>
    <table>
      <thead>
        <tr>
          <th>Code</th>
          <th>Product</th>
          <th>Batch</th>
          <th>MFG</th>
          <th>EXP</th>
          <th>Status</th>
          <th>Updated</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <h3 style="margin:16px 0 6px">L·ªãch s·ª≠</h3>
    <div id="history" class="small"></div>
  </div>
</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const msg = $("msg");
  const tbody = $("tbody");
  const historyDiv = $("history");

  function setMsg(t, kind="") {
    msg.className = "msg " + (kind||"");
    msg.textContent = t || "";
  }

  function loadProducts(){
    try { return JSON.parse(localStorage.getItem("qrdb_products") || "{}"); }
    catch { return {}; }
  }

  function loadHistory(){
    try { return JSON.parse(localStorage.getItem("qrdb_history") || "[]"); }
    catch { return []; }
  }

  function buildScanUrl(code) {
    const u = new URL("./qr.html", window.location.href);
    u.searchParams.set("token", code);
    return u.toString();
  }

  function fmtIso(iso) {
    if(!iso) return "-";
    return String(iso).replace("T"," ").slice(0,19);
  }

  function render(){
    const q = $("q").value.trim().toLowerCase();
    const db = loadProducts();
    const rows = Object.values(db).sort((a,b)=> (b.updated_at||"").localeCompare(a.updated_at||""));

    tbody.innerHTML = "";
    for (const r of rows) {
      const blob = `${r.code} ${r.product_name} ${r.batch_serial}`.toLowerCase();
      if (q && !blob.includes(q)) continue;

      const tr = document.createElement("tr");
      const scan = buildScanUrl(r.code);
      tr.innerHTML = `
        <td><a href="${scan}">${r.code}</a></td>
        <td>${r.product_name || ""}</td>
        <td>${r.batch_serial || ""}</td>
        <td>${r.mfg_date || ""}</td>
        <td>${r.exp_date || ""}</td>
        <td><span class="pill">${r.status || ""}</span></td>
        <td>${fmtIso(r.updated_at)}</td>
      `;
      tbody.appendChild(tr);
    }

    const hist = loadHistory().slice(0, 80);
    historyDiv.innerHTML = hist.length
      ? hist.map(h => `‚Ä¢ <span class="pill">${h.action}</span> <b>${h.code}</b> ‚Äî ${fmtIso(h.ts)}`).join("<br/>")
      : "(Ch∆∞a c√≥ l·ªãch s·ª≠)";
  }

  function exportCSV(){
    const db = loadProducts();
    const rows = Object.values(db);
    const headers = ["code","product_name","batch_serial","mfg_date","exp_date","note_extra","status","updated_at"];
    const escape = (v) => `"${String(v ?? "").replaceAll('"','""')}"`;
    const csv = [headers.join(",")].concat(
      rows.map(r => headers.map(h => escape(r[h])).join(","))
    ).join("\n");

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "products.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setMsg("ƒê√£ export CSV ‚úÖ", "ok");
  }

  document.addEventListener("DOMContentLoaded", () => {
    $("btnReload").onclick = () => { render(); setMsg("Reload ‚úÖ", "ok"); };
    $("btnExportCsv").onclick = () => exportCSV();
    $("btnClearHistory").onclick = () => {
      localStorage.setItem("qrdb_history", "[]");
      render();
      setMsg("ƒê√£ xo√° history ‚úÖ", "ok");
    };
    $("q").addEventListener("input", render);
    render();
  });
})();
</script>
</body>
</html>
