<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Factory V2 ‚Äî Scan</title>
  <style>
    :root{--bg:#071022;--panel:#0b1a33;--panel2:#0a1630;--txt:#d7e2ff;--muted:#92a6d6;--line:#1e3566;--ok:#8fffb7;--err:#ff8f8f;}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.4 system-ui,Segoe UI,Arial}
    .wrap{padding:18px;max-width:900px;margin:0 auto}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:18px;padding:16px}
    h1{margin:0 0 8px;font-size:20px} a{color:#b7ccff}
    .row{display:grid;grid-template-columns:160px 1fr;gap:10px;align-items:start;margin-top:10px}
    .k{color:var(--muted)} .msg.ok{color:var(--ok)} .msg.err{color:var(--err)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>üì≤ Scan Result</h1>
    <div class="k"><a href="./index.html">‚Üê Generate</a> ‚Ä¢ <a href="./admin.html">Admin</a></div>
    <div id="msg" class="msg" style="margin-top:10px;"></div>

    <div class="row"><div class="k">Token/Code</div><div id="code">-</div></div>
    <div class="row"><div class="k">Product</div><div id="product">-</div></div>
    <div class="row"><div class="k">Batch</div><div id="batch">-</div></div>
    <div class="row"><div class="k">MFG</div><div id="mfg">-</div></div>
    <div class="row"><div class="k">EXP</div><div id="exp">-</div></div>
    <div class="row"><div class="k">Note</div><div id="note">-</div></div>
    <div class="row"><div class="k">Status</div><div id="status">-</div></div>
    <div class="row"><div class="k">Updated</div><div id="updated">-</div></div>
  </div>
</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const msg = $("msg");
  function setMsg(t,k=""){ msg.className="msg "+(k||""); msg.textContent=t||""; }
  function fmtIso(iso){ return iso ? String(iso).replace("T"," ").slice(0,19) : "-"; }

  async function apiGet(path){
    if (window.qrFactory?.apiGet) return await window.qrFactory.apiGet(path);
    const r = await fetch(path); if(!r.ok) throw new Error(await r.text()); return await r.json();
  }

  document.addEventListener("DOMContentLoaded", async () => {
    const u = new URL(window.location.href);
    const token = (u.searchParams.get("token") || "").trim();
    $("code").textContent = token || "-";
    if(!token){ setMsg("Thi·∫øu token tr√™n URL. V√≠ d·ª•: /scan?token=QRXXXX","err"); return; }

    try{
      const r = await apiGet(`/api/scan?token=${encodeURIComponent(token)}`);
      if(!r.ok) { setMsg(r.message || "Not found","err"); return; }
      const d = r.data;
      setMsg("OK ‚úÖ (ƒë·ªçc DB m·ªõi nh·∫•t)","ok");
      $("product").textContent = d.product_name || "-";
      $("batch").textContent = d.batch_serial || "-";
      $("mfg").textContent = d.mfg_date || "-";
      $("exp").textContent = d.exp_date || "-";
      $("note").textContent = d.note_extra || "-";
      $("status").textContent = d.status || "-";
      $("updated").textContent = fmtIso(d.updated_at);
    }catch(e){
      setMsg("Kh√¥ng g·ªçi ƒë∆∞·ª£c server. Online: ch·∫°y node server.js. Offline: ch·∫°y b·∫±ng EXE.","err");
    }
  });
})();
</script>
</body>
</html>
