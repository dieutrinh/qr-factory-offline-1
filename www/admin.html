<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Factory V2 ‚Äî Admin</title>
  <style>
    :root{--bg:#071022;--panel:#0b1a33;--panel2:#0a1630;--txt:#d7e2ff;--muted:#92a6d6;--line:#1e3566;--btn:#2f6bff;--btn2:#203a70;--ok:#8fffb7;--err:#ff8f8f;}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.4 system-ui,Segoe UI,Arial}
    .wrap{padding:18px;max-width:1200px;margin:0 auto}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:18px;padding:16px}
    h1{margin:0 0 8px;font-size:20px} a{color:#b7ccff}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0}
    input{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#060f22;color:var(--txt);outline:none}
    button{border:1px solid var(--line);border-radius:12px;padding:10px 14px;color:var(--txt);background:var(--btn2);cursor:pointer;font-weight:600}
    button.primary{background:var(--btn);border-color:#2f6bff}
    .msg{margin-top:10px;font-size:13px}.msg.ok{color:var(--ok)}.msg.err{color:var(--err)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left;vertical-align:top}
    th{color:var(--muted);font-weight:600}
    .small{color:var(--muted);font-size:12px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>üõ†Ô∏è Admin Dashboard</h1>
    <div class="small"><a href="./index.html">‚Üê Generate</a></div>

    <div class="row">
      <input id="q" placeholder="T√¨m code / product / batch..." style="min-width:260px;flex:1" />
      <button class="primary" id="btnReload">Reload</button>
      <button id="btnExport">Export Excel</button>
      <label style="display:inline-flex;gap:8px;align-items:center">
        <input type="file" id="file" accept=".xlsx,.xls" />
        <button id="btnImport">Import Excel</button>
      </label>
    </div>

    <div id="msg" class="msg"></div>

    <h3 style="margin:14px 0 6px">Products</h3>
    <table>
      <thead>
        <tr><th>Code</th><th>Product</th><th>Batch</th><th>MFG</th><th>EXP</th><th>Status</th><th>Updated</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <h3 style="margin:16px 0 6px">History (latest)</h3>
    <div id="hist" class="small"></div>
  </div>
</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const msg = $("msg");
  const tbody = $("tbody");
  const hist = $("hist");

  function setMsg(t,k=""){ msg.className="msg "+(k||""); msg.textContent=t||""; }
  function fmtIso(iso){ return iso ? String(iso).replace("T"," ").slice(0,19) : "-"; }

  async function apiGet(path){
    if (window.qrFactory?.apiGet) return await window.qrFactory.apiGet(path);
    const r = await fetch(path); if(!r.ok) throw new Error(await r.text()); return await r.json();
  }
  async function apiPost(path, body){
    if (window.qrFactory?.apiPost) return await window.qrFactory.apiPost(path, body);
    const r = await fetch(path,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    if(!r.ok) throw new Error(await r.text()); return await r.json();
  }

  async function load(){
    const q = $("q").value.trim().toLowerCase();
    const rows = await apiGet("/api/excel/export"); // kh√¥ng d√πng json
  }

  async function loadProductsAndHistory(){
    // Products: g·ªçi API scan? kh√¥ng c√≥ list endpoint -> d√πng sqlite tr·ª±c ti·∫øp l√† n·∫∑ng
    // => trick: export Excel l√† file binary, n√™n ta t·∫°o endpoint JSON nh·ªè: d√πng /api/history + /api/scan theo code l√† kh√¥ng ti·ªán.
    // => ƒê∆°n gi·∫£n: th√™m endpoint list trong server (ƒë√£ c√≥ export excel). Nh∆∞ng ƒë·ªÉ kh·ªèi ƒë·ªïi th√™m, ta t·∫°o endpoint list ngay:
    // N·∫øu b·∫°n mu·ªën list JSON chu·∫©n, m√¨nh s·∫Ω th√™m /api/products trong server. T·∫°m th·ªùi, ta d√πng /api/history ƒë·ªÉ show activity + ch·ªâ list 50 code g·∫ßn nh·∫•t.
    const h = await apiGet("/api/history");
    const items = (h.rows || []).slice(0, 120);

    hist.innerHTML = items.map(x => `‚Ä¢ ${fmtIso(x.created_at)} ‚Äî <b>${x.action}</b> ‚Äî ${x.code}`).join("<br/>") || "(no history)";

    // L·∫•y unique code t·ª´ history r·ªìi fetch /api/scan?token=
    const codes = [...new Set(items.map(x => x.code).filter(Boolean))].slice(0, 80);
    const proms = codes.map(async c => {
      try {
        const r = await apiGet(`/api/scan?token=${encodeURIComponent(c)}`);
        return r.ok ? r.data : null;
      } catch { return null; }
    });
    const products = (await Promise.all(proms)).filter(Boolean);

    const q = $("q").value.trim().toLowerCase();
    tbody.innerHTML = "";
    for (const r of products) {
      const blob = `${r.code} ${r.product_name} ${r.batch_serial}`.toLowerCase();
      if (q && !blob.includes(q)) continue;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><a href="./qr.html?token=${encodeURIComponent(r.code)}">${r.code}</a></td>
        <td>${r.product_name||""}</td>
        <td>${r.batch_serial||""}</td>
        <td>${r.mfg_date||""}</td>
        <td>${r.exp_date||""}</td>
        <td>${r.status||""}</td>
        <td>${fmtIso(r.updated_at)}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function exportExcel(){
    // t·∫£i file tr·ª±c ti·∫øp
    const a = document.createElement("a");
    a.href = "/api/excel/export";
    a.download = "products.xlsx";
    a.click();
  }

  async function importExcel(){
    const f = $("file").files[0];
    if(!f) return setMsg("Ch·ªçn file Excel tr∆∞·ªõc","err");
    const buf = await f.arrayBuffer();
    const base64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
    const r = await apiPost("/api/excel/import", { base64 });
    if(r.ok) setMsg(`Import OK ‚úÖ rows=${r.imported}`,"ok");
    else setMsg("Import l·ªói","err");
    await loadProductsAndHistory();
  }

  document.addEventListener("DOMContentLoaded", async () => {
    $("btnReload").onclick = () => loadProductsAndHistory().catch(e=>setMsg(String(e.message||e),"err"));
    $("btnExport").onclick = () => exportExcel();
    $("btnImport").onclick = () => importExcel().catch(e=>setMsg(String(e.message||e),"err"));
    $("q").addEventListener("input", () => loadProductsAndHistory().catch(()=>{}));
    await loadProductsAndHistory();
    setMsg("Ready ‚úÖ","ok");
  });
})();
</script>
</body>
</html>
